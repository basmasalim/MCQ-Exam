<div class="space-y-2 mb-5 relative">
  <label class="text-sm font-medium">{{ label }}</label>

  <div class="flex w-full relative">
    <!-- Country Dropdown Button -->
    <button
      (click)="toggleDropdown()"
      type="button"
      class="items-center justify-center whitespace-nowrap text-sm font-medium border-2 border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-800 py-3 flex gap-1 rounded-e-none border-r-0 px-3 focus:z-10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 cursor-pointer"
      [class.border-green-500]="getValidationState() === 'valid'"
      [class.border-red-500]="getValidationState() === 'invalid'"
    >
      <span
        class="flex h-4 w-6 overflow-hidden rounded-sm bg-foreground/20 [&_svg:not([class*='size-'])]:size-full"
      >
        <img [src]="selectedCountry()?.flags?.svg" class="w-full h-full object-cover" />
      </span>
      <span class="text-xs font-medium">{{ selectedCountry()?.idd?.root || '' }}</span>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-chevrons-up-down -mr-2 size-4 opacity-50"
        aria-hidden="true"
      >
        <path d="m7 15 5 5 5-5"></path>
        <path d="m7 9 5-5 5 5"></path>
      </svg>
    </button>

    <!-- Phone Input -->
    <input
      class="input-field flex-1"
      autocomplete="tel"
      [placeholder]="selectedCountry() ? 'Enter phone number' : 'Select a country first'"
      type="tel"
      [value]="phoneNumber()"
      (input)="onPhoneNumberChange($event)"
      [class.border-green-500]="getValidationState() === 'valid'"
      [class.border-red-500]="getValidationState() === 'invalid'"
      [disabled]="!selectedCountry()"
    />

    <!-- Dropdown List -->
    @if (dropdownOpen()) {
      <div
        class="absolute z-50 top-full left-0 md:-left-2/5 mt-0.5 w-64 sm:w-80 bg-white border border-gray-200 rounded shadow-lg"
        (click)="$event.stopPropagation()"
      >
        <!-- Search Input -->
        <div class="flex items-center border-b border-gray-200 py-1 px-2">
          <img src="icons/search.svg" alt="search" class="w-4" />

          <input
            type="text"
            placeholder="Search country..."
            class="w-full px-3 py-2 focus:outline-none text-sm"
            [value]="searchTerm()"
            (input)="onSearchChange($event)"
            (click)="$event.stopPropagation()"
          />
        </div>

        <!-- Countries List -->
        <ul class="max-h-64 overflow-y-scroll overflow-x-hidden">
          @for (country of filteredCountries(); track country.cca2) {
            <li
              (click)="selectCountry(country)"
              class="px-3 py-2 text-xs font-medium hover:bg-gray-100 cursor-pointer flex items-center gap-2 border-b border-gray-50 last:border-b-0"
            >
              <img [src]="country.flags.svg" class="w-5 h-3 object-cover" />
              <span class="flex-1">{{ country.name.common }}</span>
              <span class="text-gray-500">{{ country.idd.root }}</span>
            </li>
          }
        </ul>
      </div>
    }
  </div>

  <!-- Validation Status -->
  @if (phoneNumber()) {
    <div class="flex items-center gap-2 text-xs">
      @if (getValidationState() === 'valid') {
        <span class="text-green-600 flex items-center gap-1">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M20 6L9 17l-5-5"></path>
          </svg>
          Valid: {{ getDisplayPhoneNumber() }}
        </span>
      } @else if (getValidationState() === 'invalid') {
        <span class="text-red-500 flex items-center gap-1">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          {{ validationError() }}
        </span>
      }
    </div>
  }

  <!-- Form Field Errors -->
  @if (field().touched() && field().errors().length) {
    @for (error of field().errors(); track error) {
      <p class="text-red-500 text-sm">{{ error.message }}</p>
    }
  }
</div>
